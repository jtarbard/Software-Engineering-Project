{% extends "includes/_main_layout.html"%}
{% block additional_css %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/activities.css') }}">

<!-- datetime picker -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />

<!-- FullCalender Stylesheet. Used for scheduler -->
<link href='https://unpkg.com/@fullcalendar/core@4.4.0/main.min.css' rel='stylesheet' />
<link href='https://unpkg.com/@fullcalendar/bootstrap@4.4.0/main.min.css' rel='stylesheet' />
<link href='https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.min.css' rel='stylesheet' />
<link href='https://unpkg.com/@fullcalendar/timegrid@4.4.0/main.min.css' rel='stylesheet' />

{% endblock %}

{% block title %}
Booking Page
{% endblock %}

{% block main_content %}
<!-- Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" role="dialog" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Book for</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="sessionInfo">
                <input type="hidden" name="activity_id" id="activityID">

                <ul id="sessionInfoList">
                    <!-- Session info elements added on click -->
                </ul>

                <!-- Number of people slider -->
                <div class="row" id="sessionNumPeople">
                    <div class="col-md-4">
                        <label for="sessionNumPeopleSlider">Number of people: </label>
                    </div>
                    <div class="col-md-7">
                        <input type="range" class="custom-range" min="1" max="8" data-slider-value="1" id="sessionNumPeopleSlider" name="num_people">
                    </div>
                    <div class="col-md-1">
                        <b id="sessionNumPeopleVal">1</b>
                    </div>
                </div>

                <p hidden id="membershipDiscount">0</p> <!-- 0-100. Indicates how much should be discounted, i.e. X/100 off -->
                <p hidden id="sessionPrice"></p>
                <p id="subtotal">Subtotal: £0.0</p>

                <div class="card-body" id="membershipDisplay"> <!-- TODO: Try jumbotron. I didn't know how to resize it, but on smaller size i'd imagine it to look good -->
                    <p class="display-12">No membership.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="addToBasket">Add to Basket</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->


<div class="container">
    <!-- Accordion Wrapper -->
    <div class="accordion" id="bookingAccordion">

        {% for activity in activity_types %}
            <!-- Accordion Card -->
            <div class="card">
                <div class="card-header" id={{ "heading" + activity.name.title() }}>
                    <button type="button" class="btn btn-link" data-toggle="collapse" data-target={{ "#collapse" + activity.name.title() }}>
                        {{ activity.name.title() }}
                        <i class="fa fa-chevron-down pull-right"></i>
                    </button>
                </div>
                <div id={{ "collapse" + activity.name.title() }} class="collapse" aria-labelledby={{ "heading" + activity.name.title() }} data-parent="#bookingAccordion">
                    <div class="card-body">
                        <!-- activity info -->
                        <p>{{ activity.description }}</p>
                        <!-- activity info -->

                        <h6>Book for a session:</h6>
{#                        <!-- date picker -->#}
{#                        <div class="form-group multidate" id={{ "multidate" + activity.name.title() }} name={{ "multidate" + activity.name.title() }}>#}
{#                            <input type="text" class="form-control">#}
{#                        </div>#}
{#                        <!-- date picker -->#}

                        <!-- Scheduler -->
{#                        <div id='calendar'></div>#}
                        <div id={{ "calendar" + activity.name.title() | replace(" ", "") }}></div>
                        <!-- Scheduler -->
                    </div>
                </div>
            </div>
            <!-- Accordion Card -->
        {% endfor %}

    </div>
    <!-- Accordion Wrapper -->
</div>

    <!-- original stuff -->
{#        <form class="form-inline" method="post">#}
{#        <label for="start_date">Start date:</label>#}
{#        <input type="date" name="start_date" required value="{{search_field_data["start_date"]}}"#}
{#            max="{{search_field_data["max_date"]}}" min="{{search_field_data["min_date"]}}">#}
{#        <label for="start_time">From:</label>#}
{#        <input type="time" name="start_time" required step="3600"#}
{#               value="{{search_field_data["from_time"]}}" min="{{search_field_data["min_time"]}}">#}
{#        <label for="activity">Activity:</label>#}
{#        <select name="activity">#}
{#            <option value="Any" {% if search_field_data["activity"] == "Any" %} selected {% endif %} >Any</option>#}
{#            {% for actvitiy_type in activity_types %}#}
{#                {% if actvitiy_type.activity_type_id == search_field_data["activity"] or actvitiy_type.activity_type_id == sent_activity %}#}
{#                    <option value="{{actvitiy_type.activity_type_id}}" selected="selected">{{actvitiy_type.name.capitalize()}}</option>#}
{#                {% else %}#}
{#                    <option value="{{actvitiy_type.activity_type_id}}" >{{actvitiy_type.name.capitalize()}}</option>#}
{#                {% endif %}#}
{#            {% endfor %}#}
{#        </select>#}
{#        <label for="facility">Facility:</label>#}
{#        <select name="facility">#}
{#            <option value="Any"#}
{#            {% if search_field_data["facility"] == "Any" %} selected="selected" {% endif %} >Any</option>#}
{#            {% for facility in facilities %}#}
{#                {% if facility.facility_id == search_field_data["facility"] %}#}
{#                    <option value="{{facility.facility_id}}" selected>{{facility.name.capitalize()}}</option>#}
{#                {% else %}#}
{#                    <option value="{{facility.facility_id}}" >{{facility.name.capitalize()}}</option>#}
{#                {% endif %}#}
{#            {% endfor %}#}
{#        </select>#}
{#        <input type="submit" name="reload_search" value="Refresh results">#}
{#    </form>#}
{#    <form method="post">#}
{#        {% if multiple == 'True' %}#}
{#            <button class="btn btn-primary" type="submit" name="book">Book</button>#}
{#        {% endif %}#}
{#    <div class="table-responsive">#}
{#        <table class="table">#}
{#            <thead>#}
{#                <tr><td colspan="6"> Time Table </td></tr>#}
{#            </thead>#}
{#            <tbody>#}
{#                <tr>#}
{#                    <td>Class name</td>#}
{#                    <td>Class Start Time </td>#}
{#                    <td>Class End Time</td>#}
{#                    <td>Facility</td>#}
{#                    <td>Availability left</td>#}
{#                    <td>Book</td>#}
{#                </tr>#}
{#                {% for activity, availability in activity_dict.items() %}#}
{#                    <tr>#}
{#                        <td>{{ activity.activity_type.name.title() }}</td>#}
{#                        <td>{{ activity.start_time }}</td>#}
{#                        <td>{{ activity.end_time }}</td>#}
{#                        <td><a href="/info/facilities#{{ activity.facility.facility_id }}">{{ activity.facility.name.title()}}</a></td>#}
{#                        <td>{{ availability }}</td>#}
{#                        {% if multiple == 'True' %}#}
{#                                <td>#}
{#                                    <input type="checkbox" id="{{activity.activity_id}}" name="bulk_activity" value="{{activity.activity_id}}">#}
{#                                </td>#}
{#                        {% else %}#}
{#                            <td><a class="btn btn-danger" href="/activities/view_activity/{{ activity.activity_id }}">Book</a></td>#}
{#                        {% endif %}#}
{#                    </tr>#}
{#                {% endfor %}#}
{#            </tbody>#}
{#        </table>#}
{#    </form>#}
{% endblock %}

{% block additional_js %}
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src='https://unpkg.com/@fullcalendar/core@4.4.0/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/bootstrap@4.4.0/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/interaction@4.4.0/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/timegrid@4.4.0/main.min.js'></script>

<script>
    $(document).ready(function(){
        // Add chevron-up icon for collapse element which is open by default
        $(".collapse.show").each(function(){
        	$(this).prev(".card-header").find(".fa").addClass("fa-chevron-up pull-right").removeClass("fa-chevron-up pull-right");
        });

        // Toggle chevron icon on show hide of collapse element
        $(".collapse").on('show.bs.collapse', function(){
        	$(this).prev(".card-header").find(".fa").removeClass("fa-chevron-down pull-right").addClass("fa-chevron-up pull-right");

        	// TODO: And also query a week worth's session availability for the opened activity type
        }).on('hide.bs.collapse', function(){
        	$(this).prev(".card-header").find(".fa").removeClass("fa-chevron-up pull-right").addClass("fa-chevron-down pull-right");
        });
    });

    // TODO: Maybe remove
    $(".multidate input").datepicker({
        multidate: true
    });

    // ----- Booking Calendars ----- //
    // The id/key separates each list into "buckets" for performance
    // If the list is a heap, then each insert is O(log n) so it's performant still
    var queryHistory = {}; // { activity_type_id: [{query} object literals] }. If this object literal exists, then the retrieved events must exist
    var existingSessions = {}; // { activity_type_id: [{session} object literals] }.

    document.addEventListener('DOMContentLoaded', function() {
        var calendars = {}; // { activity_type_id: calendarObject}

        {% for activity_type in activity_types %}

            // initialize
            queryHistory[{{ activity_type.activity_type_id }}] = [];
            existingSessions[{{ activity_type.activity_type_id }}] = [];

            var calendarEl = document.getElementById("calendar{{ activity_type.name.title() | string | replace(" ", "") }}");

            calendars[{{ activity_type.activity_type_id }}] = new FullCalendar.Calendar(calendarEl, {
                plugins: [ 'bootstrap', 'interaction', 'dayGrid', 'timeGrid' ],
                defaultView: 'dayGridWeek',
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: [],

                // ----- Event Handlers ----- //
                // Click on an session
                eventClick: function(info) {
                    // Show session info
                    var modal = $('#bookingModal');
                    modal.modal('show');

                    $("#activityID").val(info.event.extendedProps.id);

                    // Perform an ajax request to get all the session info
                    $.ajax({
                        type : "POST",
                        url : "{{ url_for("activities.query_session") }}",
                        data: JSON.stringify(info.event.extendedProps),
                        contentType: 'application/json;charset=UTF-8',
                        success: function(session) {
                            session = JSON.parse(session);

                            var modal = $('#bookingModal');
                            var sessionInfoList = modal.find("#sessionInfoList");

                            sessionInfoList.html(
                                "<li>Start time: " + info.event.start + "</li>\n" +
                                "<li>End time: " + info.event.end + "</li>\n" +
                                "<li>Minimum age: " + session.minimum_age + "</li>\n" +
                                "<li>Spaces left: " + session.spaces_left + "</li>\n" +
                                "<li>Price for one: £" + session.session_price + "</li>"
                            );
                            modal.find("#sessionNumPeopleSlider").attr("max", session.max_booking);
                            modal.find("#sessionPrice").val(session.session_price);
                            modal.find("#subtotal").html("<p>Subtotal: £" + session.subtotal + "</p>");

                            {% if User.__mapper_args__ ['polymorphic_identity'] == "Manager" %}
                            sessionInfoList.append(
                                "<li><b>Manager Info:</b></li>",
                                "<li>Total bookings: " + session.total_bookings + "</li>",
                                "<li>Income: " + session.activity_income + "</li>",
                                "<li>Cost: " + session.activity_cost + "</li>"
                            );
                            {% endif %}

                            if (session.membership_name !== undefined) {
                                modal.find("#membershipDisplay p").html(
                                    session.membership_discount + "% Off discount applied for your " + session.membership_name + " membership."
                                );
                                modal.find("#membershipDiscount").val(session.membership_discount);
                            } else {
                                modal.find("#membershipDisplay").attr("hidden", "hidden");
                            }
                        },
                        error: function(jqXHR) {
                            // TODO: Make this user friendly
                            alert("An error occurred. Perhaps the internet connection between you and the website's server is interrupted.")
                            console.log(jqXHR);
                        }
                    });

                    modal.find(".modal-title").text("Book for " + info.event.title);
                },

                // When a new set of dates has been rendered, query the info for uncached sessions, and put them into the calendar
                datesRender: function(info) {
                    let query = {
                        activity_type_id: {{ activity_type.activity_type_id }},
                        start_date: info.view.activeStart,
                        end_date: info.view.activeEnd
                    };
                    query = JSON.stringify(query);

                    // check against cache
                    if (!queryHistory[{{ activity_type.activity_type_id }}].includes(query)) {
                        queryHistory[{{ activity_type.activity_type_id }}].push(query);

                        $.ajax({
                            type : "POST",
                            url : "{{ url_for("activities.query_sessions") }}",
                            data: query,
                            contentType: 'application/json;charset=UTF-8',
                            success: function(results) {
                                results = JSON.parse(results);
                                for (let i = 0; i < results.length; i++) {
                                    var session = {
                                        title: results[i].name,
                                        start: results[i].start,
                                        end: results[i].end,
                                        extendedProps: {
                                            id: results[i].id
                                        }
                                    };
                                    var sessionStr = JSON.stringify(session);

                                    // if event doesn't exist in existingSessions, add to existingSessions and add to calendar
                                    if (!existingSessions[{{ activity_type.activity_type_id }}].includes(sessionStr)) {
                                        existingSessions[{{ activity_type.activity_type_id }}].push(sessionStr);
                                        calendars[{{ activity_type.activity_type_id }}].addEvent(session);
                                    }
                                }
                            },
                            error: function(jqXHR) {
                                // TODO: Make this user friendly
                                alert("An error occurred. Perhaps the internet connection between you and the website's server is interrupted.");
                                console.log(jqXHR);
                            }
                        });
                    }
                },

                // don't rerender everytime an event is added
                // TODO: Not sure how to use this
                batchRendering: function() {

                }
            });

            calendars[{{ activity_type.activity_type_id }}].render();

        {% endfor %}
    });

    // Add to basket button
    $("#addToBasket").on("click", function(e) {
        console.log("hi posting data");
        $.post("/misc/add_booking_to_basket", {
            "activity": $("#activityID").val(),
            "amount_of_people": $("#sessionNumPeopleSlider").val()
        });
    });

    // Number of people slider
    var slider = $("#sessionNumPeopleSlider");
    slider.val(1);
    // TODO: Add tooltip. Also make it change on slide ("slide" should've been an event but it doesn't work. Check https://seiyria.com/bootstrap-slider/#example-2 <<<<< also .slider is not a function)
    slider.on("change", function(e) {
        $("#sessionNumPeopleVal").html($(this).val());
        // Also update the subtotal price   TODO: Bad #135
        $("#subtotal").html("<p>Subtotal: £" + $("#sessionPrice").val() * $(this).val() * (100-$("#membershipDiscount").val())/100 + "</p>");
    });
</script>
{% endblock %}