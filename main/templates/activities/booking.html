{% extends "includes/_main_layout.html"%}
{% block additional_css %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/activities.css') }}">

<!-- datetime picker -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />

<!-- FullCalender Stylesheet. Used for scheduler -->
<link href='https://unpkg.com/@fullcalendar/core@4.4.0/main.min.css' rel='stylesheet' />
<link href='https://unpkg.com/@fullcalendar/bootstrap@4.4.0/main.min.css' rel='stylesheet' />
<link href='https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.min.css' rel='stylesheet' />
<link href='https://unpkg.com/@fullcalendar/timegrid@4.4.0/main.min.css' rel='stylesheet' />

{% endblock %}

{% block title %}
Booking Page
{% endblock %}

{% block main_content %}
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
  Launch demo modal
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal -->


<div class="container">
    <!-- Accordion Wrapper -->
    <div class="accordion" id="bookingAccordion">

        {% for activity in activity_types %}
            <!-- Accordion Card -->
            <div class="card">
                <div class="card-header" id={{ "heading" + activity.name.title() }}>
                    <h2 class="mb-0">
                        <button type="button" class="btn btn-link" data-toggle="collapse" data-target={{ "#collapse" + activity.name.title() }}>
                            {{ activity.name.title() }}
                            <i class="fa fa-chevron-down pull-right"></i>
                        </button>
                    </h2>
                </div>
                <div id={{ "collapse" + activity.name.title() }} class="collapse" aria-labelledby={{ "heading" + activity.name.title() }} data-parent="#bookingAccordion">
                    <div class="card-body">
                        <!-- activity info -->
                        <p>{{ activity.description }}</p>
                        <!-- activity info -->

                        <h6>Book for a session:</h6>
{#                        <!-- date picker -->#}
{#                        <div class="form-group multidate" id={{ "multidate" + activity.name.title() }} name={{ "multidate" + activity.name.title() }}>#}
{#                            <input type="text" class="form-control">#}
{#                        </div>#}
{#                        <!-- date picker -->#}

                        <!-- Scheduler -->
{#                        <div id='calendar'></div>#}
                        <div id={{ "calendar" + activity.name.title() | replace(" ", "") }}></div>
                        <!-- Scheduler -->
                    </div>
                </div>
            </div>
            <!-- Accordion Card -->
        {% endfor %}

    </div>
    <!-- Accordion Wrapper -->
</div>

    <!-- original stuff -->
{#        <form class="form-inline" method="post">#}
{#        <label for="start_date">Start date:</label>#}
{#        <input type="date" name="start_date" required value="{{search_field_data["start_date"]}}"#}
{#            max="{{search_field_data["max_date"]}}" min="{{search_field_data["min_date"]}}">#}
{#        <label for="start_time">From:</label>#}
{#        <input type="time" name="start_time" required step="3600"#}
{#               value="{{search_field_data["from_time"]}}" min="{{search_field_data["min_time"]}}">#}
{#        <label for="activity">Activity:</label>#}
{#        <select name="activity">#}
{#            <option value="Any" {% if search_field_data["activity"] == "Any" %} selected {% endif %} >Any</option>#}
{#            {% for actvitiy_type in activity_types %}#}
{#                {% if actvitiy_type.activity_type_id == search_field_data["activity"] or actvitiy_type.activity_type_id == sent_activity %}#}
{#                    <option value="{{actvitiy_type.activity_type_id}}" selected="selected">{{actvitiy_type.name.capitalize()}}</option>#}
{#                {% else %}#}
{#                    <option value="{{actvitiy_type.activity_type_id}}" >{{actvitiy_type.name.capitalize()}}</option>#}
{#                {% endif %}#}
{#            {% endfor %}#}
{#        </select>#}
{#        <label for="facility">Facility:</label>#}
{#        <select name="facility">#}
{#            <option value="Any"#}
{#            {% if search_field_data["facility"] == "Any" %} selected="selected" {% endif %} >Any</option>#}
{#            {% for facility in facilities %}#}
{#                {% if facility.facility_id == search_field_data["facility"] %}#}
{#                    <option value="{{facility.facility_id}}" selected>{{facility.name.capitalize()}}</option>#}
{#                {% else %}#}
{#                    <option value="{{facility.facility_id}}" >{{facility.name.capitalize()}}</option>#}
{#                {% endif %}#}
{#            {% endfor %}#}
{#        </select>#}
{#        <input type="submit" name="reload_search" value="Refresh results">#}
{#    </form>#}
{#    <form method="post">#}
{#        {% if multiple == 'True' %}#}
{#            <button class="btn btn-primary" type="submit" name="book">Book</button>#}
{#        {% endif %}#}
{#    <div class="table-responsive">#}
{#        <table class="table">#}
{#            <thead>#}
{#                <tr><td colspan="6"> Time Table </td></tr>#}
{#            </thead>#}
{#            <tbody>#}
{#                <tr>#}
{#                    <td>Class name</td>#}
{#                    <td>Class Start Time </td>#}
{#                    <td>Class End Time</td>#}
{#                    <td>Facility</td>#}
{#                    <td>Availability left</td>#}
{#                    <td>Book</td>#}
{#                </tr>#}
{#                {% for activity, availability in activity_dict.items() %}#}
{#                    <tr>#}
{#                        <td>{{ activity.activity_type.name.title() }}</td>#}
{#                        <td>{{ activity.start_time }}</td>#}
{#                        <td>{{ activity.end_time }}</td>#}
{#                        <td><a href="/info/facilities#{{ activity.facility.facility_id }}">{{ activity.facility.name.title()}}</a></td>#}
{#                        <td>{{ availability }}</td>#}
{#                        {% if multiple == 'True' %}#}
{#                                <td>#}
{#                                    <input type="checkbox" id="{{activity.activity_id}}" name="bulk_activity" value="{{activity.activity_id}}">#}
{#                                </td>#}
{#                        {% else %}#}
{#                            <td><a class="btn btn-danger" href="/activities/view_activity/{{ activity.activity_id }}">Book</a></td>#}
{#                        {% endif %}#}
{#                    </tr>#}
{#                {% endfor %}#}
{#            </tbody>#}
{#        </table>#}
{#    </form>#}
{% endblock %}

{% block additional_js %}
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src='https://unpkg.com/@fullcalendar/core@4.4.0/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/bootstrap@4.4.0/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/interaction@4.4.0/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/timegrid@4.4.0/main.min.js'></script>

<script>
    $(document).ready(function(){
        // Add chevron-up icon for collapse element which is open by default
        $(".collapse.show").each(function(){
        	$(this).prev(".card-header").find(".fa").addClass("fa-chevron-up pull-right").removeClass("fa-chevron-up pull-right");
        });

        // Toggle chevron icon on show hide of collapse element
        $(".collapse").on('show.bs.collapse', function(){
        	$(this).prev(".card-header").find(".fa").removeClass("fa-chevron-down pull-right").addClass("fa-chevron-up pull-right");

        	// TODO: And also query a week worth's session availability for the opened activity type
        }).on('hide.bs.collapse', function(){
        	$(this).prev(".card-header").find(".fa").removeClass("fa-chevron-up pull-right").addClass("fa-chevron-down pull-right");
        });
    });

    // TODO: Maybe remove
    $(".multidate input").datepicker({
        multidate: true
    });

    // ----- Booking Calendars ----- //
    // The id/key separates each list into "buckets" for performance
    // If the list is a heap, then each insert is O(log n) so it's performant still
    var queryHistory = {}; // { activity_type_id: [{query} object literals] }. If this object literal exists, then the retrieved events must exist
    var existingSessions = {}; // { activity_type_id: [{session} object literals] }.

    document.addEventListener('DOMContentLoaded', function() {
        var calendars = {}; // { activity_type_id: calendarObject}

        {% for activity_type in activity_types %}

            // initialize
            queryHistory[{{ activity_type.activity_type_id }}] = [];
            existingSessions[{{ activity_type.activity_type_id }}] = [];

            var calendarEl = document.getElementById("calendar{{ activity_type.name.title() | string | replace(" ", "") }}");

            calendars[{{ activity_type.activity_type_id }}] = new FullCalendar.Calendar(calendarEl, {
                plugins: [ 'bootstrap', 'interaction', 'dayGrid', 'timeGrid' ],
                defaultView: 'dayGridWeek',
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: [
{#                    {% for session in session_availabilities %}#}
{#                        {#}
{#                            title: "{{ activity_type.name.title() }}",#}
{#                            start: "{{ session.start_time.strftime("%Y-%m-%dT%H:%M:%S") }}",#}
{#                            end: "{{ session.end_time.strftime("%Y-%m-%dT%H:%M:%S") }}"#}
{#                        },#}
{#                    {% endfor %}#}
                ],

                // ----- Event Handlers ----- //
                // Click on an session
                eventClick: function(info) {
                    // Show session info
                    $('#exampleModal').modal('show');
                },

                // When a new set of dates has been rendered, query the info for uncached sessions, and put them into the calendar
                datesRender: function(info) {
                    let query = {
                        activity_type_id: {{ activity_type.activity_type_id }},
                        start_date: info.view.activeStart,
                        end_date: info.view.activeEnd
                    };
                    query = JSON.stringify(query);

                    // check against cache
                    if (!queryHistory[{{ activity_type.activity_type_id }}].includes(query)) {
                        queryHistory[{{ activity_type.activity_type_id }}].push(query);

                        $.ajax({
                            type : "POST",
                            url : "{{ url_for("activities.query_sessions") }}",
                            data: query,
                            contentType: 'application/json;charset=UTF-8',
                            success: function(results) {
                                results = JSON.parse(results);
                                for (let i = 0; i < results.length; i++) {
                                    var session = {
                                        title: results[i].name,
                                        start: results[i].start,
                                        end: results[i].end
                                    };
                                    var sessionStr = JSON.stringify(session);

                                    // if event doesn't exist in existingSessions, add to existingSessions and add to calendar
                                    if (!existingSessions[{{ activity_type.activity_type_id }}].includes(sessionStr)) {
                                        existingSessions[{{ activity_type.activity_type_id }}].push(sessionStr);
                                        calendars[{{ activity_type.activity_type_id }}].addEvent(session);
                                    }
                                }
                            }
                        });
                    }
                },

                // don't rerender everytime an event is added
                // TODO: Not sure how to use this
                batchRendering: function() {

                }
            });

            calendars[{{ activity_type.activity_type_id }}].render();

        {% endfor %}
    });
</script>
{% endblock %}